# 多IP功能集成指南

## 概述

本指南说明如何将多IP支持功能集成到原始的 `sb.sh` 脚本中。

## 文件说明

1. **multi_ip_helper.sh** - 多IP检测和管理辅助函数
2. **multi_ip_config_generator.sh** - 多IP配置文件生成器
3. **sb_multi_ip.sh** - 独立的多IP配置工具（简化版）
4. **VPS多IP配置说明.md** - VPS网络配置说明文档

## 集成步骤

### 步骤1：在原脚本开头添加辅助函数引用

在 `sb.sh` 的开头部分（约第15行后）添加：

```bash
# 加载多IP支持函数
if [[ -f "$(dirname "$0")/multi_ip_helper.sh" ]]; then
    source "$(dirname "$0")/multi_ip_helper.sh"
fi
if [[ -f "$(dirname "$0")/multi_ip_config_generator.sh" ]]; then
    source "$(dirname "$0")/multi_ip_config_generator.sh"
fi
```

### 步骤2：修改 `inssbjsonser()` 函数

找到 `inssbjsonser()` 函数（约第420行），修改为支持多IP的版本：

**原代码：**
```bash
inssbjsonser(){
cat > /etc/s-box/sb10.json <<EOF
{
  "inbounds": [
    {
      "type": "vless",
      "listen": "::",
      "listen_port": ${port_vl_re},
      ...
    }
  ]
}
EOF
}
```

**修改为：**
```bash
inssbjsonser(){
    # 检测所有IP
    local ips=($(detect_all_ips))
    local ip_count=${#ips[@]}
    
    if [[ $ip_count -gt 1 ]]; then
        # 多IP模式
        generate_multi_ip_config_json
    else
        # 单IP模式（原逻辑）
        generate_single_ip_config_json
    fi
}

generate_multi_ip_config_json() {
    local inbounds_json="["
    local ip_index=1
    local base_port=20000
    
    # 清空映射文件
    > /etc/s-box/ip_port_mapping.txt
    
    for ip in "${ips[@]}"; do
        # 为每个IP分配端口
        local ports=($(allocate_ports_for_ip $ip_index $base_port))
        local port_vl_re=$(find_available_port ${ports[0]})
        local port_vm_ws=$(find_available_port ${ports[1]})
        local port_hy2=$(find_available_port ${ports[2]})
        local port_tu=$(find_available_port ${ports[3]})
        
        # 保存映射
        echo "$ip|$port_vl_re|$port_vm_ws|$port_hy2|$port_tu" >> /etc/s-box/ip_port_mapping.txt
        
        # 生成inbound配置（为每个IP生成4个协议）
        if [[ $ip_index -gt 1 ]]; then
            inbounds_json+=","
        fi
        
        # Vless-reality
        inbounds_json+="{
      \"type\": \"vless\",
      \"sniff\": true,
      \"sniff_override_destination\": true,
      \"tag\": \"vless-sb-ip${ip_index}\",
      \"listen\": \"$ip\",
      \"listen_port\": $port_vl_re,
      \"users\": [{\"uuid\": \"${uuid}\", \"flow\": \"xtls-rprx-vision\"}],
      \"tls\": {
        \"enabled\": true,
        \"server_name\": \"${ym_vl_re}\",
        \"reality\": {
          \"enabled\": true,
          \"handshake\": {\"server\": \"${ym_vl_re}\", \"server_port\": 443},
          \"private_key\": \"$private_key\",
          \"short_id\": [\"$short_id\"]
        }
      }
    },"
        
        # Vmess-ws
        inbounds_json+="{
        \"type\": \"vmess\",
        \"sniff\": true,
        \"sniff_override_destination\": true,
        \"tag\": \"vmess-sb-ip${ip_index}\",
        \"listen\": \"$ip\",
        \"listen_port\": $port_vm_ws,
        \"users\": [{\"uuid\": \"${uuid}\", \"alterId\": 0}],
        \"transport\": {
            \"type\": \"ws\",
            \"path\": \"${uuid}-vm-ip${ip_index}\",
            \"max_early_data\":2048,
            \"early_data_header_name\": \"Sec-WebSocket-Protocol\"    
        },
        \"tls\":{
                \"enabled\": ${tlsyn},
                \"server_name\": \"${ym_vm_ws}\",
                \"certificate_path\": \"$certificatec_vmess_ws\",
                \"key_path\": \"$certificatep_vmess_ws\"
            }
    },"
        
        # Hysteria2
        inbounds_json+="    {
        \"type\": \"hysteria2\",
        \"sniff\": true,
        \"sniff_override_destination\": true,
        \"tag\": \"hy2-sb-ip${ip_index}\",
        \"listen\": \"$ip\",
        \"listen_port\": $port_hy2,
        \"users\": [{\"password\": \"${uuid}\"}],
        \"ignore_client_bandwidth\":false,
        \"tls\": {
            \"enabled\": true,
            \"alpn\": [\"h3\"],
            \"certificate_path\": \"$certificatec_hy2\",
            \"key_path\": \"$certificatep_hy2\"
        }
    },"
        
        # Tuic5
        inbounds_json+="        {
            \"type\":\"tuic\",
            \"sniff\": true,
            \"sniff_override_destination\": true,
            \"tag\": \"tuic5-sb-ip${ip_index}\",
            \"listen\": \"$ip\",
            \"listen_port\": $port_tu,
            \"users\": [{\"uuid\": \"${uuid}\", \"password\": \"${uuid}\"}],
            \"congestion_control\": \"bbr\",
            \"tls\":{
                \"enabled\": true,
                \"alpn\": [\"h3\"],
                \"certificate_path\": \"$certificatec_tuic\",
                \"key_path\": \"$certificatep_tuic\"
            }
        }"
        
        ((ip_index++))
    done
    
    inbounds_json+="]"
    
    # 生成完整配置文件（包含outbounds等）
    cat > /etc/s-box/sb10.json <<EOF
{
  "log": {
    "disabled": false,
    "level": "info",
    "timestamp": true
  },
  "inbounds": $inbounds_json,
  "outbounds": [
    {
      "type":"direct",
      "tag":"direct",
      "domain_strategy": "$ipv"
    }
    // ... 其他outbounds配置
  ]
}
EOF
}
```

### 步骤3：修改节点分享函数

找到 `result_vl_vm_hy_tu()` 和 `resvless()` 等函数（约第979行），修改为支持多IP：

```bash
resvless_multi_ip(){
    local ips=($(cat /etc/s-box/all_ips.txt))
    local uuid=$(sed 's://.*::g' /etc/s-box/sb.json | jq -r '.inbounds[0].users[0].uuid')
    local public_key=$(cat /etc/s-box/public.key)
    
    echo
    white "=========================================="
    red "所有IP的Vless-reality节点"
    white "=========================================="
    
    local ip_index=1
    while IFS='|' read -r ip port_vl port_vm port_hy2 port_tu; do
        local vl_name=$(sed 's://.*::g' /etc/s-box/sb.json | jq -r '.inbounds[0].tls.server_name')
        local short_id=$(sed 's://.*::g' /etc/s-box/sb.json | jq -r '.inbounds[0].tls.reality.short_id[0]')
        
        echo
        green "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        green "IP #$ip_index: $ip"
        green "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        
        local vl_link="vless://$uuid@$ip:$port_vl?encryption=none&flow=xtls-rprx-vision&security=reality&sni=$vl_name&fp=chrome&pbk=$public_key&sid=$short_id&type=tcp&headerType=none#vl-reality-$ip"
        
        echo "$vl_link"
        echo "$vl_link" >> /etc/s-box/vl_reality_all.txt
        
        qrencode -o - -t ANSIUTF8 "$vl_link"
        
        ((ip_index++))
    done < /etc/s-box/ip_port_mapping.txt
}
```

### 步骤4：在主菜单添加多IP选项

在主菜单函数（约第5238行）添加新选项：

```bash
green "17. 多IP节点配置和管理"
```

在case语句中添加：
```bash
17 ) multi_ip_menu;;
```

### 步骤5：创建多IP管理菜单

添加新函数：

```bash
multi_ip_menu(){
    echo
    white "=========================================="
    red "多IP节点管理"
    white "=========================================="
    echo
    green "1. 检测并显示所有IP地址"
    green "2. 重新生成多IP配置"
    green "3. 查看所有IP的节点链接"
    green "4. 测试IP连通性"
    green "0. 返回主菜单"
    echo
    readp "请选择 [0-4]: " choice
    
    case "$choice" in
        1) show_all_ips;;
        2) 
            yellow "重新生成配置..."
            # 调用配置生成函数
            ;;
        3) generate_all_nodes_summary "$uuid" "$ym_vl_re" "$public_key" "$short_id" "$ym_vm_ws";;
        4)
            local ips=($(detect_all_ips))
            for ip in "${ips[@]}"; do
                if test_ip_connectivity "$ip"; then
                    green "$ip: 可达"
                else
                    red "$ip: 不可达"
                fi
            done
            ;;
        0) sb;;
        *) red "无效选择";;
    esac
}
```

## 使用说明

### 1. 部署文件

将所有文件上传到VPS：
```bash
# 上传到与sb.sh相同的目录
multi_ip_helper.sh
multi_ip_config_generator.sh
sb_multi_ip.sh
```

### 2. 设置执行权限

```bash
chmod +x multi_ip_helper.sh
chmod +x multi_ip_config_generator.sh
chmod +x sb_multi_ip.sh
```

### 3. 运行脚本

**方式1：使用独立的多IP脚本（推荐先测试）**
```bash
bash sb_multi_ip.sh
```

**方式2：使用集成后的原脚本**
```bash
bash sb.sh
# 然后选择新增的多IP选项
```

## 注意事项

1. **备份原脚本**：修改前请备份原始的 `sb.sh`
2. **测试环境**：建议先在测试环境验证
3. **端口冲突**：确保端口范围不与现有服务冲突
4. **防火墙**：确保防火墙规则正确配置
5. **IP验证**：确保所有IP都能正常访问

## 故障排查

如果遇到问题，请检查：
1. 辅助函数文件是否正确加载
2. IP检测是否正常工作
3. 端口是否被占用
4. sing-box配置文件格式是否正确
5. 服务是否能正常启动

## 完整示例

完整的集成示例代码请参考 `multi_ip_config_generator.sh` 中的实现。

