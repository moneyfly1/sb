# Sing-box 多IP配置快速使用指南

## 📋 文件清单

已为您创建以下文件：

1. **multi_ip_helper.sh** - IP检测和管理辅助函数
2. **multi_ip_config_generator.sh** - 多IP配置文件生成器  
3. **sb_multi_ip.sh** - 独立的多IP配置工具（可直接使用）
4. **VPS多IP配置说明.md** - VPS网络配置详细说明
5. **集成指南.md** - 如何将功能集成到原sb.sh脚本

## 🚀 快速开始

### 方法1：使用独立的多IP脚本（推荐先测试）

```bash
# 1. 上传所有文件到VPS
# 2. 设置执行权限
chmod +x sb_multi_ip.sh multi_ip_helper.sh multi_ip_config_generator.sh

# 3. 运行脚本
bash sb_multi_ip.sh
```

### 方法2：集成到原sb.sh脚本

按照 `集成指南.md` 中的步骤修改原 `sb.sh` 脚本。

## 📝 使用步骤

### 步骤1：检查VPS IP配置

在VPS上运行以下命令检查所有IP：

```bash
# 查看所有IP地址
ip addr show | grep "inet "

# 或使用
ifconfig | grep "inet "
```

您应该能看到类似这样的输出：
```
inet 66.253.7.112/24 scope global eth0
inet 66.253.5.69/24 scope global eth0
inet 66.253.5.113/24 scope global eth0
inet 66.253.5.159/24 scope global eth0
```

### 步骤2：验证IP连通性

```bash
# 测试每个IP是否可达
ping -c 3 66.253.7.112
ping -c 3 66.253.5.69
ping -c 3 66.253.5.113
ping -c 3 66.253.5.159
```

### 步骤3：配置防火墙

```bash
# Ubuntu/Debian
ufw allow 20000:25000/tcp
ufw allow 20000:25000/udp

# CentOS
firewall-cmd --permanent --add-port=20000-25000/tcp
firewall-cmd --permanent --add-port=20000-25000/udp
firewall-cmd --reload
```

### 步骤4：运行多IP配置脚本

```bash
bash sb_multi_ip.sh
```

脚本会自动：
- ✅ 检测所有IP地址
- ✅ 为每个IP分配端口（每个IP 4个协议，共16个端口）
- ✅ 生成配置文件
- ✅ 生成节点分享链接

## 📊 端口分配规则

每个IP使用独立的端口范围（间隔1000）：

| IP | Vless | Vmess | Hysteria2 | Tuic5 |
|----|-------|-------|-----------|-------|
| IP1 | 20000 | 20001 | 20002 | 20003 |
| IP2 | 21000 | 21001 | 21002 | 21003 |
| IP3 | 22000 | 22001 | 22002 | 22003 |
| IP4 | 23000 | 23001 | 23002 | 23003 |

## 📤 节点输出

配置完成后，节点信息保存在：

- `/etc/s-box/ip_port_mapping.txt` - IP和端口映射表
- `/etc/s-box/nodes_ip*.txt` - 每个IP的节点链接
- `/etc/s-box/all_ips.txt` - 所有检测到的IP列表

## 🔧 常见问题

### Q1: 脚本检测不到所有IP？

**A:** 检查IP是否正确绑定到网络接口：
```bash
ip addr add <IP地址>/24 dev eth0  # 如果IP未绑定
```

### Q2: 某些IP无法访问？

**A:** 
1. 检查防火墙规则
2. 检查路由配置：`ip route show`
3. 联系VPS提供商确认IP配置

### Q3: 端口被占用？

**A:** 脚本会自动检测并调整端口。如果仍有问题：
```bash
# 查看端口占用
ss -tunlp | grep <端口号>
```

### Q4: 节点无法连接？

**A:**
1. 检查sing-box服务：`systemctl status sing-box`
2. 查看日志：`journalctl -u sing-box -f`
3. 验证配置文件：`/etc/s-box/sb.json`

## 📚 详细文档

- **VPS网络配置** → 查看 `VPS多IP配置说明.md`
- **集成到原脚本** → 查看 `集成指南.md`
- **函数说明** → 查看各.sh文件中的注释

## ⚠️ 重要提示

1. **备份原脚本**：修改前请备份 `sb.sh`
2. **测试环境**：建议先在测试VPS上验证
3. **端口范围**：确保20000-25000端口范围未被占用
4. **IP数量**：建议不超过10个IP，避免配置过于复杂

## 🎯 预期结果

配置成功后，您将获得：

- ✅ 4个IP地址
- ✅ 每个IP 4个协议节点（Vless、Vmess、Hysteria2、Tuic5）
- ✅ 共16个节点配置
- ✅ 所有节点链接和二维码

## 📞 需要帮助？

如果遇到问题，请提供：
1. VPS系统信息：`uname -a`
2. IP配置信息：`ip addr show`
3. 脚本运行日志
4. sing-box运行日志：`journalctl -u sing-box -n 50`

---

**祝您使用愉快！** 🎉

